<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TMDB Post Generator + Gmail API</title>
  <style>
    body { font-family: Arial; background: #f7f7f7; padding: 20px; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; }
    input, textarea, button, select { width: 100%; padding: 10px; margin: 8px 0; border-radius: 5px; border: 1px solid #ccc; }
    button { background: #007bff; color: white; font-weight: bold; cursor: pointer; }
    button:hover { background: #0056b3; }
    #output { background: #222; color: #0f0; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2 align="center">üé¨ TMDB Post Generator + Gmail Publisher</h2>

  <div class="container">
    <div>
      <select id="type">
        <option value="movie">Movie</option>
        <option value="tv">TV Show</option>
      </select>
      <input type="text" id="tmdbId" placeholder="Enter TMDB ID">
      <button id="fetchBtn">Fetch from TMDB</button>
    </div>

    <input id="title" placeholder="Title">
    <input id="tagline" placeholder="Tagline">
    <textarea id="overview" placeholder="Overview"></textarea>
    <input id="releaseDate" placeholder="Release Date">
    <input id="runtime" placeholder="Runtime (min)">
    <input id="rating" placeholder="Rating">
    <input id="genres" placeholder="Genres (comma separated)">
    <input id="language" placeholder="Language">
    <input id="cast" placeholder="Main Cast (comma separated)">
    <input id="trailer" placeholder="Trailer YouTube URL">

    <h3>üíæ Download Links</h3>
    <div id="downloadContainer">
      <div class="flex">
        <input type="text" placeholder="Download Text" class="downloadText">
        <input type="text" placeholder="Download URL" class="downloadUrl">
      </div>
    </div>
    <button id="addDownload">‚ûï Add Download</button>
    <button id="generateBtn">‚ö° Generate HTML</button>
    <button id="sendBtn">üì® Send via Gmail API</button>

    <h3>üìù Output</h3>
    <div id="output"></div>
  </div>

  <script>
    const TMDB_API_KEY = "c9ac3637696d089a9b1a1781518778a0";

    async function fetchTMDB() {
      const id = document.getElementById("tmdbId").value.trim();
      const type = document.getElementById("type").value;
      if (!id) return alert("Enter TMDB ID");
      const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB_API_KEY}&append_to_response=videos,credits`);
      const data = await res.json();

      if (data.success === false) return alert("Invalid TMDB ID");
      document.getElementById("title").value = data.title || data.name || "";
      document.getElementById("tagline").value = data.tagline || "";
      document.getElementById("overview").value = data.overview || "";
      document.getElementById("releaseDate").value = data.release_date || data.first_air_date || "";
      document.getElementById("runtime").value = data.runtime || (data.episode_run_time ? data.episode_run_time[0] : "");
      document.getElementById("rating").value = data.vote_average || "";
      document.getElementById("genres").value = data.genres?.map(g => g.name).join(", ") || "";
      document.getElementById("language").value = data.original_language || "";
      document.getElementById("cast").value = data.credits?.cast?.slice(0, 5).map(c => c.name).join(", ") || "";
      const trailer = data.videos?.results?.find(v => v.type === "Trailer");
      document.getElementById("trailer").value = trailer ? `https://www.youtube.com/watch?v=${trailer.key}` : "";
    }

    function generateHTML() {
      const title = document.getElementById("title").value;
      const tagline = document.getElementById("tagline").value;
      const overview = document.getElementById("overview").value;
      const releaseDate = document.getElementById("releaseDate").value;
      const runtime = document.getElementById("runtime").value;
      const rating = document.getElementById("rating").value;
      const genres = document.getElementById("genres").value;
      const language = document.getElementById("language").value;
      const cast = document.getElementById("cast").value;
      const trailer = document.getElementById("trailer").value;

      let downloadHTML = "";
      document.querySelectorAll(".downloadText").forEach((textEl, i) => {
        const text = textEl.value.trim();
        const url = document.querySelectorAll(".downloadUrl")[i].value.trim();
        if (text && url) downloadHTML += `<p><a href="${url}" target="_blank"><b>${text}</b></a></p>`;
      });

      const html = `
<h2><b>${title}</b></h2>
<p><i>${tagline}</i></p>
<p><b>Release Date:</b> ${releaseDate}</p>
<p><b>Runtime:</b> ${runtime} min</p>
<p><b>Rating:</b> ${rating}/10</p>
<p><b>Genres:</b> ${genres}</p>
<p><b>Language:</b> ${language}</p>
<p><b>Cast:</b> ${cast}</p>
<p>${overview}</p>
${trailer ? `<iframe width="560" height="315" src="${trailer.replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen></iframe>` : ""}
<h3>Download Links</h3>
${downloadHTML}
`;
      document.getElementById("output").textContent = html.trim();
      return { title, genres, html };
    }

    async function sendPost() {
      const { title, genres, html } = generateHTML();
      if (!title || !html) return alert("Generate the post first.");

      const res = await fetch("/send-post", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, genres, html }),
      });

      const data = await res.json();
      alert(data.success ? "‚úÖ Post sent to Blogger Email!" : "‚ùå Failed: " + data.error);
    }

    document.getElementById("fetchBtn").addEventListener("click", fetchTMDB);
    document.getElementById("generateBtn").addEventListener("click", generateHTML);
    document.getElementById("sendBtn").addEventListener("click", sendPost);
    document.getElementById("addDownload").addEventListener("click", () => {
      const div = document.createElement("div");
      div.className = "flex";
      div.innerHTML = `
        <input type="text" placeholder="Download Text" class="downloadText">
        <input type="text" placeholder="Download URL" class="downloadUrl">
      `;
      document.getElementById("downloadContainer").appendChild(div);
    });
  </script>
</body>
</html>
